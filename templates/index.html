{% extends 'base.html' %}

{% block title %}Kalender â€“ Ambrotos{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
{% endblock %}

{% block content %}
<div class="app-layout">

  <!-- â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <nav class="navbar">
    <div class="navbar-brand">ðŸ“… {% if current_team %}{{ current_team.name }}{% else %}Ambrotos{% endif %} Kalender</div>
    <div class="navbar-user">
      {% if user_teams|length > 1 or current_user.is_admin %}
      <div class="team-selector" id="teamSelector">
        <button class="btn btn-sm btn-outline" id="teamDropdownBtn" onclick="toggleTeamDropdown()">
          {% if current_team %}{{ current_team.name }}{% else %}VÃ¦lg team{% endif %} â–¾
        </button>
        <div class="dropdown-menu" id="teamDropdownMenu" style="display:none">
          {% for team in user_teams %}
          <button class="dropdown-item {% if current_team and team.id == current_team.id %}active{% endif %}"
                  onclick="switchTeam({{ team.id }})">
            {{ team.name }}
          </button>
          {% endfor %}
        </div>
      </div>
      {% endif %}
      <span id="backupIndicator" class="backup-indicator backup-indicator--unknown" title="Backup status ukendt">
        <span class="backup-dot"></span><span class="backup-label">Backup</span>
      </span>
      <span class="user-dot" style="background: {{ current_user.color }}"></span>
      <span class="user-name">{{ current_user.username }}</span>
      {% if current_user.is_admin %}
      <a href="{{ url_for('admin_panel') }}" class="btn btn-sm btn-outline">âš™ Admin</a>
      {% endif %}
      <a href="{{ url_for('logout') }}" class="btn btn-sm btn-outline">Log ud</a>
    </div>
  </nav>

  <!-- â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="main-content">

    <!-- Calendar -->
    <div class="calendar-panel">
      <div class="calendar-toolbar">
        <button id="eventModeBtn" class="btn btn-outline btn-sm event-mode-btn" onclick="toggleEventMode()">
          + Opret event
        </button>
        <span id="eventModeHint" class="event-mode-hint" style="display:none">
          Klik pÃ¥ en dato for at oprette et event
        </span>
      </div>
      <div id="calendar"></div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar">

      <!-- Legend -->
      <div class="card legend-card">
        <h3 class="card-title">Medlemmer</h3>
        <div class="legend-list">
          {% for user in users %}
          <div class="legend-item">
            <span class="legend-dot" style="background: {{ user.color }}"></span>
            <span class="legend-name {% if user.id == current_user.id %}legend-you{% endif %}">
              {{ user.username }}{% if user.id == current_user.id %} <em>(dig)</em>{% endif %}
            </span>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Upcoming Events -->
      <div class="card events-card">
        <h3 class="card-title">Kommende events</h3>
        <div id="upcomingEvents" class="upcoming-events-list">
          <p class="events-empty">IndlÃ¦serâ€¦</p>
        </div>
      </div>

    </aside>
  </div>
</div>

<!-- â”€â”€ Date detail modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="modalOverlay" style="display:none" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modalDate">Dato</h3>
      <button class="modal-close" id="modalClose" aria-label="Luk">&times;</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<!-- â”€â”€ Event create/edit modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="eventCreateOverlay" style="display:none" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modal-header">
      <h3 id="eventCreateHeading">Nyt event</h3>
      <button class="modal-close" onclick="closeEventCreateModal()" aria-label="Luk">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="eventTitle">Navn</label>
        <input type="text" id="eventTitle" placeholder="Navn pÃ¥ eventâ€¦" autocomplete="off">
      </div>
      <div class="form-group">
        <label for="eventDesc">Beskrivelse (valgfri)</label>
        <textarea id="eventDesc" rows="3" placeholder="Kort beskrivelseâ€¦"></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="eventStartDate">Fra</label>
          <input type="date" id="eventStartDate">
        </div>
        <div class="form-group">
          <label for="eventEndDate">Til (valgfri)</label>
          <input type="date" id="eventEndDate">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="eventOrganizer1">ArrangÃ¸r 1 (valgfri)</label>
          <select id="eventOrganizer1"><option value="">â€” ingen â€”</option></select>
        </div>
        <div class="form-group">
          <label for="eventOrganizer2">ArrangÃ¸r 2 (valgfri)</label>
          <select id="eventOrganizer2"><option value="">â€” ingen â€”</option></select>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-primary btn-full" id="eventSubmitBtn" onclick="submitEventCreate()">Opret event</button>
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€ Event detail modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="eventDetailOverlay" style="display:none" role="dialog" aria-modal="true">
  <div class="modal modal-wide">
    <div class="modal-header">
      <h3 id="eventDetailTitle">Event</h3>
      <button class="modal-close" onclick="closeEventDetailModal()" aria-label="Luk">&times;</button>
    </div>
    <div class="modal-body">
      <p class="event-detail-date" id="eventDetailDate"></p>
      <p class="event-detail-desc" id="eventDetailDesc"></p>
      <p class="event-detail-creator" id="eventDetailCreator"></p>
      <p class="event-detail-organizers" id="eventDetailOrganizers"></p>
      <div class="event-detail-actions" id="eventDetailActions"></div>
      <div class="attendance-section" id="eventAttendance"></div>
      <div class="comments-section">
        <h4 class="comments-title">Kommentarer</h4>
        <div id="eventComments" class="comments-list"></div>
        <div class="comment-input-area">
          <input type="text" id="commentInput" placeholder="Skriv en kommentarâ€¦" autocomplete="off">
          <button class="btn btn-primary btn-sm" onclick="submitComment()">Send</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const CURRENT_USER_ID = {{ current_user.id }};
  const IS_ADMIN = {{ current_user.is_admin|tojson }};
  const IS_TEAM_ADMIN = {{ is_team_admin|tojson }};
  const CURRENT_TEAM_ID = {{ current_team.id if current_team else 'null' }};
  const CURRENT_TEAM_NAME = {{ (current_team.name if current_team else 'Ambrotos')|tojson }};
</script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/locales-all.global.min.js"></script>
<script src="{{ url_for('static', filename='js/app.js') }}"></script>
<script>
(function () {
  function timeAgo(isoStr) {
    if (!isoStr) return '';
    const diffSec = Math.floor((Date.now() - new Date(isoStr + 'Z')) / 1000);
    if (diffSec < 60) return 'lige nu';
    if (diffSec < 3600) return Math.floor(diffSec / 60) + ' min siden';
    if (diffSec < 86400) return Math.floor(diffSec / 3600) + ' t siden';
    return Math.floor(diffSec / 86400) + ' d siden';
  }

  function updateBackupIndicator(data) {
    const el = document.getElementById('backupIndicator');
    if (!el) return;
    const localOk = data.local_ok;
    const ftpOk = data.ftp_ok;
    const ftpEnabled = data.ftp_enabled;
    const ok = localOk === true && (!ftpEnabled || ftpOk === true);
    const failed = localOk === false || (ftpEnabled && ftpOk === false);
    el.className = 'backup-indicator ' + (ok ? 'backup-indicator--ok' : failed ? 'backup-indicator--error' : 'backup-indicator--unknown');
    const localTime = timeAgo(data.local_time);
    const parts = [];
    if (data.local_time) parts.push('Lokal: ' + (localOk ? 'âœ“' : 'âœ—') + ' ' + localTime);
    if (ftpEnabled) parts.push('FTP: ' + (ftpOk === true ? 'âœ“' : ftpOk === false ? 'âœ—' : '?') + (data.ftp_time ? ' ' + timeAgo(data.ftp_time) : ''));
    el.title = parts.length ? parts.join('\n') : 'Backup status ukendt';
  }

  function fetchBackupStatus() {
    fetch('/api/backup-status').then(r => r.json()).then(updateBackupIndicator).catch(() => {});
  }

  fetchBackupStatus();
  setInterval(fetchBackupStatus, 120000); // Poll every 2 minutes
})();
</script>
{% endblock %}
