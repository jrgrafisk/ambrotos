# Automatiske daglige backups kl. 12 og 22

Denne l√∏sning tilf√∏jer en **automatisk backup-funktion**, der k√∏rer hver dag kl. 12:00 og 22:00, udover den eksisterende backup-logik, der k√∏rer ved √¶ndringer i databasen.

## 1. Tilf√∏j afh√¶ngighed
Tilf√∏j `apscheduler` til `requirements.txt`:
```txt
apscheduler>=3.9.1
```

## 2. Tilf√∏j backup-scheduler til `app.py`
Tilf√∏j f√∏lgende kode **√∏verst i `app.py`** (fx efter `import`-sektionen):

```python
from apscheduler.schedulers.background import BackgroundScheduler
from apscheduler.triggers.cron import CronTrigger

# Opret en scheduler til daglige backups
backup_scheduler = BackgroundScheduler()

def scheduled_backup():
    """Kaldes af scheduleren for at tage en backup kl. 12 og 22."""
    with app.app_context():
        print("üïí K√∏rer planlagt backup...")
        write_backup()
        push_backup_to_ftp()

# Start scheduleren, n√•r appen starter
def start_backup_scheduler():
    # K√∏r hver dag kl. 12:00 og 22:00
    backup_scheduler.add_job(
        scheduled_backup,
        trigger=CronTrigger(hour="12,22", timezone="Europe/Copenhagen"),
        id="daily_backup",
        name="Tag daglig backup kl. 12 og 22",
        replace_existing=True,
    )
    backup_scheduler.start()
    print("‚è∞ Backup-scheduler startet (kl. 12 og 22).")
```

## 3. Opdater `app.py` for at starte scheduleren
Find linjen, hvor `app` initialiseres (fx efter `init_db()`), og tilf√∏j:

```python
# Start backup-scheduleren
start_backup_scheduler()
```

Eksempel:
```python
if __name__ == '__main__':
    init_db()
    start_backup_scheduler()  # Tilf√∏j denne linje
    app.run(debug=True, host='0.0.00', port=5000)
```

## 4. Installer afh√¶ngigheden
K√∏r:
```bash
pip install apscheduler>=3.9.1
```

## 5. Vigtige noter
- **Hosting-kompatibilitet**: Render Free/Starter underst√∏tter ikke langk√∏rende processer. Brug **Pro-planen** eller en **ekstern cron-job-tjeneste** (fx Cron-job.org).
- **Logs**: Du vil se `üïí K√∏rer planlagt backup...` i loggen, n√•r en backup k√∏res.
- **Fejlfinding**: Tjek loggen for fejlmeddelelser, hvis backups ikke k√∏res.

## 6. Alternativ: Ekstern cron-job (hvis scheduleren ikke virker)
Hvis din hosting ikke underst√∏tter `apscheduler`, kan du oprette et **ny endpoint** og kalde det via en ekstern cron-tjeneste:

### Tilf√∏j et endpoint til manuel backup
```python
@app.route('/admin/trigger-backup', methods=['POST'])
@admin_required
def trigger_backup():
    write_backup()
    push_backup_to_ftp()
    return jsonify({"status": "success", "message": "Backup triggeret manuelt."})
```

### Ops√¶t en cron-job eksternt
1. Opret en cron-job p√• [Cron-job.org](https://cron-job.org/) eller [EasyCron](https://www.easycron.com/).
2. Indstil den til at kalde:
   ```
   POST https://ambrotos.jrgrafisk.dk/admin/trigger-backup
   ```
   hver dag kl. 12:00 og 22:00.
3. Tilf√∏j en **API-n√∏gle** eller **basic auth** for at sikre endpointet.

## 7. Test l√∏sningen
- **Lokalt**: K√∏r appen og vent til kl. 12 eller 22 (eller √¶ndr tiden midlertidigt til test).
  - Du b√∏r se `üïí K√∏rer planlagt backup...` i loggen.
- **P√• Render**: Hvis du bruger Pro-planen, b√∏r det virke. Ellers brug det eksterne cron-alternativ.

## 8. Fejlfinding
- **Logs**: Tjek loggen for `üïí K√∏rer planlagt backup...`. Hvis du ikke ser det, k√∏rer scheduleren ikke.
- **FTP-fejl**: Hvis FTP-upload fejler, tjek `FTP_HOST`, `FTP_USER`, og `FTP_PASS`.
- **Timeouts**: P√• delt hosting kan langk√∏rende processer dr√¶bes. Brug en VPS eller ekstern cron-job.